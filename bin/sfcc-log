#!/usr/bin/env bash
set -e
[ -n "$DEBUG" ] && set -x

host=$SFCC_DL_HOST
path="/on/demandware.servlet/webdav/Sites/Impex/archive/catalog"
user=$SFCC_DL_USER
count=${1-10}
pattern=${2-mastercatalog}

main() {
  curl -sN -u "$user" "ihttps://${host}${path}" | sed -n /$pattern/p | sed 's/.*<a href="\(.*\)"><tt>.*/\1/g' | head -n $count > url.lst
  while read url; do
    filename=$(echo "https://${host}${url}" | sed 's/.*\/\(.*\.xml\).*/\1/g')
    echo $filename
    curl -s -u "$user" -o "$filename" "https://${host}${url}"
  done < url.lst

  for file in *.xml; do
    xml fo $file > temp
    mv temp $file
  done
}

cleanup() {
  rm url.lst
}
trap cleanup EXIT

main
exit 0
